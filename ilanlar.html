<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTClx_9DlBcYyCGUNKnmBxvt5f-zKK7PWEFEuFgg7Zk9lR2l2FOlsAoSIrheFT_9dpj1OVYPfh9aNdB/pub?output=csv";

// ✔ Profesyonel CSV Parser (Virgül, tırnak sorunu yaşamaz)
function parseCSV(csv) {
    const rows = [];
    let insideQuotes = false;
    let row = [];
    let value = "";

    for (let i = 0; i < csv.length; i++) {
        const char = csv[i];

        if (char === '"' && csv[i + 1] === '"') {
            value += '"';
            i++;
        } else if (char === '"') {
            insideQuotes = !insideQuotes;
        } else if (char === ',' && !insideQuotes) {
            row.push(value);
            value = "";
        } else if (char === '\n' && !insideQuotes) {
            row.push(value);
            rows.push(row);
            row = [];
            value = "";
        } else {
            value += char;
        }
    }
    if (value) row.push(value);
    if (row.length) rows.push(row);
    return rows;
}

function ilanlariCek() {
    fetch(CSV_URL)
        .then(r => r.text())
        .then(text => {
            const rows = parseCSV(text);

            const headers = rows[0].map(h => h.trim());
            const ilanlar = [];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row.length) continue;

                const ilan = {};
                headers.forEach((h, idx) => {
                    ilan[h] = row[idx] ? row[idx].trim() : "";
                });

                // Başlık yoksa ekleme
                if (!ilan["Baslik"]) continue;

                ilanlar.push(ilan);
            }

            ilanlariGoster(ilanlar.reverse());
        })
        .catch(err => {
            document.getElementById("ilanlar-listesi").innerHTML =
                `<p style="color:red">İlanlar yüklenemedi. Google Sheets ayarlarınızı kontrol edin.</p>`;
        });
}

function ilanlariGoster(ilanlar) {
    const container = document.getElementById("ilanlar-listesi");

    if (ilanlar.length === 0) {
        container.innerHTML = "<p>Hiç ilan eklenmemiş.</p>";
        return;
    }

    let html = "";

    ilanlar.forEach(ilan => {
        const baslik = ilan["Baslik"];
        const link = ilan["Facebook_Link"] && ilan["Facebook_Link"].startsWith("http")
            ? ilan["Facebook_Link"]
            : null;

        html += `
        <div class="ilan-kutusu">
            <div class="ilan-baslik">${baslik}</div>
            <div class="ilan-link">
                ${
                    link
                        ? `<a href="${link}" target="_blank">Facebook İlanına Git</a>`
                        : `<span style="color:var(--muted)">Facebook linki girilmemiş</span>`
                }
            </div>
        </div>`;
    });

    container.innerHTML = html;
}

ilanlariCek();
</script>

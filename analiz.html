import streamlit as st
import pandas as pd
import smtplib
import urllib.parse
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# --- GÄ°ZLÄ° AYARLAR ---
def ayar_getir(anahtar, varsayilan):
    try:
        return st.secrets[anahtar]
    except:
        return varsayilan

GÃ–NDEREN_EMAIL = ayar_getir("GÃ–NDEREN_EMAIL", "piyazsosu@gmail.com")
UYGULAMA_SIFRESI = ayar_getir("UYGULAMA_SIFRESI", "ikafvsebounnuhng")
WHATSAPP_NUMARASI = ayar_getir("WHATSAPP_NUMARASI", "905355739260")

# --- VERÄ° YÃœKLEME ---
try:
    df = pd.read_csv('emlak_verileri.csv', sep=None, engine='python', encoding='utf-8-sig')
    df.columns = df.columns.str.strip()
except:
    st.error("Veri dosyasÄ± yÃ¼klenemedi.")
    st.stop()

# --- E-POSTA MOTORU ---
def mail_gonder(konu, icerik):
    try:
        mesaj = MIMEMultipart()
        mesaj['From'] = GÃ–NDEREN_EMAIL
        mesaj['To'] = GÃ–NDEREN_EMAIL
        mesaj['Subject'] = konu
        mesaj.attach(MIMEText(icerik, 'plain'))
        sunucu = smtplib.SMTP_SSL('smtp.gmail.com', 465)
        sunucu.login(GÃ–NDEREN_EMAIL, UYGULAMA_SIFRESI.replace(" ", ""))
        sunucu.sendmail(GÃ–NDEREN_EMAIL, GÃ–NDEREN_EMAIL, mesaj.as_string())
        sunucu.quit()
        return True
    except:
        return False

# --- TASARIM (CSS) ---
st.set_page_config(page_title="Analiz | Selman GÃ¼neÅŸ", page_icon="ğŸ¡", layout="wide")

st.markdown("""
    <style>
    header {
        background-color: #2c3e50;
        color: white;
        padding: 30px 10px;
        text-align: center;
        border-radius: 0 0 15px 15px;
        margin-bottom: 25px;
    }
    header h1 { color: #ffffff !important; font-size: 24px !important; }
    header nav a {
        color: #3498db !important;
        text-decoration: none;
        margin: 0 10px;
        font-weight: bold;
    }
    .info-card {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border-top: 3px solid #3498db;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin: 5px 0;
    }
    .footer {
        text-align: center;
        padding: 20px;
        background-color: #2c3e50;
        color: #bdc3c7;
        margin-top: 40px;
    }
    </style>
    """, unsafe_allow_html=True)

# --- HEADER (Linkler analiz.html olarak gÃ¼ncellendi) ---
st.markdown("""
    <header>
        <h1>Selman GÃ¼neÅŸ â€” Kepez & Antalya Gayrimenkul DanÄ±ÅŸmanÄ±</h1>
    <nav>
            <a href="https://emlakcrm.github.io/emlak/index.html" target="_self">Ana Sayfa</a>  
            <a href="https://emlakcrm.github.io/emlak/ilanlar.html" target="_self">Ä°lanlar</a>
            <a href="https://emlakcrm.github.io/emlak/arayis.html" target="_self">Talep</a>
            <a href="https://emlakcrm.github.io/emlak/blog/index.html" target="_self">Rehber</a>
            <a href="https://emlakcrm.github.io/emlak/hakkimda.html" target="_self">HakkÄ±mda</a>
            <a href="https://emlakcrm.github.io/emlak/resimler.html" target="_self">Foto Galeri</a> 
            <a href="https://fiyatla.streamlit.app/" target="_blank">Analiz</a>
            <a href="https://emlakcrm.github.io/emlak/borcodeme.html" target="_self">BorÃ§ Ã–deme</a>
            <a href="https://emlakcrm.github.io/emlak/diger.html" target="_self">DiÄŸer Ä°ÅŸler</a>
            <a href="https://emlakcrm.github.io/emlak/antalya.html" target="_self">Antalya</a>
            <a href="https://emlakcrm.github.io/emlak/iletisim.html" target="_self">Ä°letiÅŸim</a>
        </nav>
    </header>
    """, unsafe_allow_html=True)

# --- ANALÄ°Z FORMU ---
with st.form("ekspertiz_formu"):
    st.subheader("ğŸ¡ Ãœcretsiz Fiyat Analiz Formu")
    col1, col2 = st.columns(2)
    with col1:
        mahalle = st.selectbox("ğŸ“ Mahalle:", df['Mahalle'].unique())
        oda = st.selectbox("ğŸ›ï¸ Oda SayÄ±sÄ±:", ["1+1", "2+1", "3+1", "4+1", "5+1", "Dubleks"])
        bina_yasi = st.number_input("â³ Bina YaÅŸÄ±:", 0, 100, 5)
        asansor = st.radio("ğŸ›— AsansÃ¶r:", ["Var", "Yok"], horizontal=True)
    with col2:
        cephe = st.selectbox("â˜€ï¸ Cephe:", ["GÃ¼ney", "Kuzey", "DoÄŸu", "BatÄ±", "GÃ¼ney-DoÄŸu", "GÃ¼ney-BatÄ±"])
        kat_sayisi = st.number_input("ğŸ¢ Toplam Kat:", 1, 50, 5)
        bulundugu_kat = st.selectbox("â¬†ï¸ Kat:", ["GiriÅŸ", "1", "2", "3", "4", "5", "10+", "En Ãœst"])
        m2 = st.number_input("ğŸ“ Metrekare:", 30, 1000, 100)

    notlar = st.text_area("ğŸ“ Ek Notlar:")
    ad = st.text_input("AdÄ±nÄ±z SoyadÄ±nÄ±z:")
    tel = st.text_input("Telefonunuz:")
    
    c1, c2 = st.columns(2)
    if c1.form_submit_button("ğŸ“§ Mail Ä°le Analiz"):
        mod = "mail"
    if c2.form_submit_button("ğŸ’¬ WhatsApp Ä°le Analiz"):
        mod = "wa"
    else:
        mod = None

# --- Ä°ÅLEMLER ---
if (mod == "mail" or mod == "wa") and ad and tel:
    filtre = df[(df['Mahalle'] == mahalle) & (df['Oda_Sayisi'] == oda)]
    min_f = int(filtre['Fiyat'].min()) if not filtre.empty else 0
    max_f = int(filtre['Fiyat'].max()) if not filtre.empty else 0
    f_sonuc = f"â‚º{min_f:,} - â‚º{max_f:,}".replace(',', '.') if min_f > 0 else "Ä°letiÅŸime GeÃ§in"
    
    mesaj = (f"Analiz Talebi\nÄ°sim: {ad}\nTel: {tel}\n"
             f"MÃ¼lk: {mahalle}, {oda}, {m2}m2\nDeÄŸer: {f_sonuc}")

    if mod == "mail":
        if mail_gonder(f"Analiz - {ad}", mesaj): st.success("Mail GÃ¶nderildi!")
    
    if mod == "wa":
        st.link_button("ğŸ“² WHATSAPP'TAN GÃ–NDER", f"https://wa.me/{WHATSAPP_NUMARASI}?text={urllib.parse.quote(mesaj)}", type="primary", use_container_width=True)

    st.markdown(f'<div style="background-color:white; padding:20px; border-radius:10px; border:2px solid #3498db; text-align:center;"><h3>Tahmini DeÄŸer</h3><h1>{f_sonuc}</h1></div>', unsafe_allow_html=True)

# --- TANITIM KARTLARI ---
st.write("---")
k1, k2, k3 = st.columns(3)
with k1: st.markdown('<div class="info-card"><h4>ğŸ“ BÃ¶lge Analizi</h4><p>GÃ¼ncel piyasa verileri.</p></div>', unsafe_allow_html=True)
with k2: st.markdown('<div class="info-card"><h4>ğŸ“ Kriter Analizi</h4><p>10 farklÄ± teknik detay.</p></div>', unsafe_allow_html=True)
with k3: st.markdown('<div class="info-card"><h4>ğŸ¤ Uzman DesteÄŸi</h4><p>Selman GÃ¼neÅŸ farkÄ±.</p></div>', unsafe_allow_html=True)

# --- FOOTER ---
st.markdown(f'<div class="footer"><p>Â© 2024 Selman GÃ¼neÅŸ Emlak | Tel: {WHATSAPP_NUMARASI}</p></div>', unsafe_allow_html=True)
